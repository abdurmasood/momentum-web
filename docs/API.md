# API Reference

## Overview

Momentum's API consists of:
1. **NextAuth API Routes** - Authentication endpoints (auto-generated by NextAuth)
2. **Custom API Routes** - JWT token generation
3. **Future API Routes** - Cron jobs, webhooks, etc. [REVIEW: Document if implemented]

All API routes follow Next.js App Router conventions and are located in `src/app/api/`.

## API Structure

```
src/app/api/
├── auth/
│   ├── [...nextauth]/        # NextAuth API handler
│   │   └── route.ts
│   └── generate-token/        # Custom JWT generation
│       └── route.ts
└── cron/                      # Scheduled jobs (if implemented)
    └── ...
```

## NextAuth API Routes

### Base Path

**Pattern**: `/api/auth/*`

**Handler Location**: [src/app/api/auth/[...nextauth]/route.ts](../src/app/api/auth/[...nextauth]/route.ts)

**Implementation**:
```typescript
import { handlers } from "@/lib/auth"

export const { GET, POST } = handlers
```

**What This Does**:
- Exports NextAuth's pre-built route handlers
- Handles all authentication flows automatically
- Configures routes based on [src/lib/auth.ts](../src/lib/auth.ts) configuration

### Available Endpoints

All endpoints are auto-generated by NextAuth v5:

#### 1. Sign In Page

**Endpoint**: `GET /api/auth/signin`

**Purpose**: Renders default sign-in page (not used - custom `/login` page instead)

**Response**: HTML sign-in page

**Note**: Momentum uses custom login page at `/login` instead

---

#### 2. Initiate Sign In

**Endpoint**: `POST /api/auth/signin/:provider`

**Purpose**: Start authentication flow for a provider

**Providers**:
- `/api/auth/signin/google` - Google OAuth
- `/api/auth/signin/email` - Email magic link

**Request Body** (email provider):
```json
{
  "email": "user@example.com",
  "callbackUrl": "/auth/callback"
}
```

**Response**: Redirects to provider or shows verification page

**Client Usage**:
```typescript
import { signIn } from 'next-auth/react'

// Google OAuth
await signIn('google', { callbackUrl: '/auth/callback' })

// Email magic link
await signIn('email', {
  email: 'user@example.com',
  callbackUrl: '/auth/callback'
})
```

---

#### 3. OAuth Callback

**Endpoint**: `GET /api/auth/callback/:provider`

**Purpose**: Handle OAuth provider redirects

**Example**: `GET /api/auth/callback/google?code=...&state=...`

**Flow**:
1. User approves OAuth consent screen
2. Provider redirects to this endpoint with auth code
3. NextAuth exchanges code for tokens
4. Creates/updates user in database
5. Redirects to `callbackUrl` (default: `/auth/callback`)

**Not Called Directly**: Browser automatically redirected by OAuth provider

---

#### 4. Email Verification

**Endpoint**: `GET /api/auth/callback/email?token=...&email=...`

**Purpose**: Verify magic link token from email

**Query Parameters**:
- `token` - Verification token (hashed)
- `email` - User's email address

**Flow**:
1. User clicks magic link in email
2. Browser opens this URL
3. NextAuth validates token (expires in 10 minutes)
4. Creates/updates user in database
5. Deletes verification token (single-use)
6. Redirects to `callbackUrl`

**Not Called Directly**: User clicks link from email

---

#### 5. Sign Out Page

**Endpoint**: `GET /api/auth/signout`

**Purpose**: Renders default sign-out confirmation page

**Response**: HTML confirmation page

**Note**: Can use custom signout flow if needed

---

#### 6. Sign Out Action

**Endpoint**: `POST /api/auth/signout`

**Purpose**: Sign out current user

**Request**: No body required (uses session cookie)

**Response**: Redirects to homepage or specified `callbackUrl`

**Client Usage**:
```typescript
import { signOut } from 'next-auth/react'

await signOut({ callbackUrl: '/' })
```

**What Happens**:
- Deletes session cookie
- Removes database session (if using database sessions)
- Redirects to specified URL

---

#### 7. Get Session

**Endpoint**: `GET /api/auth/session`

**Purpose**: Retrieve current user session

**Authentication**: Optional (returns `null` if not authenticated)

**Response** (authenticated):
```json
{
  "user": {
    "id": "ckl0r5q2z0000z2z5g5y5z5z5",
    "email": "user@example.com",
    "name": "User Name",
    "image": "https://..."
  },
  "expires": "2025-01-22T10:00:00.000Z"
}
```

**Response** (not authenticated):
```json
null
```

**Client Usage**:
```typescript
import { useSession } from 'next-auth/react'

function Component() {
  const { data: session, status } = useSession()

  if (status === 'loading') return <div>Loading...</div>
  if (status === 'unauthenticated') return <div>Not signed in</div>

  return <div>Hello {session.user.name}</div>
}
```

**Server Usage**:
```typescript
import { auth } from '@/lib/auth'

export async function GET() {
  const session = await auth()

  if (!session) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }

  return NextResponse.json({ user: session.user })
}
```

---

#### 8. CSRF Token

**Endpoint**: `GET /api/auth/csrf`

**Purpose**: Get CSRF token for form submissions

**Response**:
```json
{
  "csrfToken": "abc123def456..."
}
```

**Usage**: Automatically handled by NextAuth's `signIn()` function

---

#### 9. Providers List

**Endpoint**: `GET /api/auth/providers`

**Purpose**: List available authentication providers

**Response**:
```json
{
  "google": {
    "id": "google",
    "name": "Google",
    "type": "oauth",
    "signinUrl": "/api/auth/signin/google",
    "callbackUrl": "/api/auth/callback/google"
  },
  "email": {
    "id": "email",
    "name": "Email",
    "type": "email",
    "signinUrl": "/api/auth/signin/email",
    "callbackUrl": "/api/auth/callback/email"
  }
}
```

**Client Usage**:
```typescript
import { getProviders } from 'next-auth/react'

const providers = await getProviders()
```

## Custom API Routes

### Generate Dashboard Token

**Endpoint**: `POST /api/auth/generate-token`

**Location**: [src/app/api/auth/generate-token/route.ts](../src/app/api/auth/generate-token/route.ts)

**Purpose**: Generate custom JWT for dashboard authentication after NextAuth login

**Authentication**: ✅ Required (NextAuth session)

**Request**:
- **Method**: `POST`
- **Headers**: None required (session cookie sent automatically)
- **Body**: None

**Response** (success - 200):
```json
{
  "success": true,
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyIjp7ImlkIjoiY2tsMHI1cTJ6MDAwMHoyejVnNXk1ejV6NSIsImVtYWlsIjoidXNlckBleGFtcGxlLmNvbSIsIm5hbWUiOiJVc2VyIE5hbWUifSwiZXhwIjoxNzA1NjQ4MDAwLCJpYXQiOjE3MDUwNDMyMDB9.signature"
}
```

**Response** (no session - 401):
```json
{
  "success": false,
  "message": "Invalid session: missing required user information"
}
```

**Response** (server error - 500):
```json
{
  "success": false,
  "message": "Failed to generate token"
}
```

**Implementation**:
```typescript
export async function POST() {
  try {
    // Verify authenticated with NextAuth
    const session = await auth()

    // Validate session has required properties
    if (!isValidSession(session)) {
      return NextResponse.json(
        {
          success: false,
          message: "Invalid session: missing required user information"
        },
        { status: 401 }
      )
    }

    // Generate custom JWT for dashboard
    const token = generateDashboardToken({
      id: session.user.id,
      email: session.user.email,
      name: session.user.name,
    })

    return NextResponse.json({ success: true, token })
  } catch (error) {
    console.error("Token generation error:", error)
    return NextResponse.json(
      { success: false, message: "Failed to generate token" },
      { status: 500 }
    )
  }
}
```

**JWT Payload**:
```typescript
{
  user: {
    id: string,        // User ID from database
    email: string,     // User email
    name: string       // User name (or email username as fallback)
  },
  exp: number,         // Expiration (7 days from issue)
  iat: number          // Issued at timestamp
}
```

**Security**:
- ✅ Requires active NextAuth session
- ✅ Validates session structure with type guard
- ✅ Signed with `JWT_SECRET` (min 32 chars)
- ✅ 7-day expiration
- ✅ HTTPS-only in production

**Client Usage**:
```typescript
// Called automatically by /auth/callback page
const response = await fetch('/api/auth/generate-token', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
})

const data = await response.json()

if (data.success) {
  // Redirect to dashboard with token
  window.location.href = `${DASHBOARD_URL}/dashboard/auth?token=${data.token}`
}
```

**Flow**:
1. User completes NextAuth authentication (Google or email)
2. NextAuth redirects to `/auth/callback`
3. Callback page calls this endpoint
4. Endpoint validates session and generates JWT
5. JWT sent to dashboard app via URL parameter
6. Dashboard validates JWT and creates session

**Error Handling**:
- Invalid session → 401 Unauthorized
- Missing user data → 401 Unauthorized
- Token generation failure → 500 Internal Server Error
- All errors logged to console (development) or logging service (production)

## Cron Jobs / Scheduled Tasks

[REVIEW: Document if cron jobs are implemented]

**Potential Endpoints**:
- `/api/cron/cleanup-tokens` - Delete expired verification tokens
- `/api/cron/cleanup-sessions` - Delete expired sessions

**Location**: `src/app/api/cron/` (if exists)

**Security**: Verify requests from Vercel Cron (check `Authorization` header)

**Vercel Cron Configuration**:
```json
// vercel.json
{
  "crons": [
    {
      "path": "/api/cron/cleanup-tokens",
      "schedule": "0 * * * *"  // Every hour
    }
  ]
}
```

## API Best Practices

### Authentication

**Pattern**:
```typescript
import { auth } from '@/lib/auth'

export async function GET() {
  const session = await auth()

  if (!session) {
    return NextResponse.json(
      { error: 'Unauthorized' },
      { status: 401 }
    )
  }

  // Proceed with authenticated request
}
```

**Type Guard**:
```typescript
import { isValidSession } from '@/lib/auth'

if (!isValidSession(session)) {
  return NextResponse.json(
    { error: 'Invalid session' },
    { status: 401 }
  )
}

// TypeScript now knows session.user has id, email, name
```

### Error Handling

**Pattern**:
```typescript
export async function POST(request: Request) {
  try {
    const body = await request.json()

    // Validate input
    if (!body.email) {
      return NextResponse.json(
        { error: 'Email is required' },
        { status: 400 }
      )
    }

    // Process request
    const result = await processRequest(body)

    return NextResponse.json({ success: true, data: result })
  } catch (error) {
    console.error('API error:', error)

    // Don't expose internal errors to client
    return NextResponse.json(
      { error: 'Internal server error' },
      { status: 500 }
    )
  }
}
```

**Status Codes**:
- `200` - Success
- `400` - Bad request (validation error)
- `401` - Unauthorized (not authenticated)
- `403` - Forbidden (authenticated but not authorized)
- `404` - Not found
- `500` - Internal server error

### Request Validation

**Validate Input**:
```typescript
interface RequestBody {
  email: string
  name?: string
}

export async function POST(request: Request) {
  const body: unknown = await request.json()

  // Validate structure
  if (
    !body ||
    typeof body !== 'object' ||
    !('email' in body) ||
    typeof body.email !== 'string'
  ) {
    return NextResponse.json(
      { error: 'Invalid request body' },
      { status: 400 }
    )
  }

  // Type-safe access
  const { email, name } = body as RequestBody
}
```

**Or use Zod**:
```typescript
import { z } from 'zod'

const schema = z.object({
  email: z.string().email(),
  name: z.string().optional(),
})

export async function POST(request: Request) {
  const body = await request.json()

  const result = schema.safeParse(body)

  if (!result.success) {
    return NextResponse.json(
      { error: 'Invalid input', details: result.error.errors },
      { status: 400 }
    )
  }

  const { email, name } = result.data
}
```

[REVIEW: Is Zod installed? If not, consider adding for validation]

### CORS Headers

**If API is called from external domains**:
```typescript
export async function GET() {
  const response = NextResponse.json({ data: 'value' })

  response.headers.set('Access-Control-Allow-Origin', '*')
  response.headers.set('Access-Control-Allow-Methods', 'GET, POST, OPTIONS')

  return response
}
```

**Note**: Momentum's API is internal-only (same domain), so CORS not needed currently.

### Rate Limiting

[REVIEW: Is rate limiting implemented?]

**Potential Implementation** (using Vercel Edge Config or Upstash):
```typescript
import { ratelimit } from '@/lib/ratelimit'

export async function POST(request: Request) {
  const ip = request.headers.get('x-forwarded-for') ?? 'unknown'

  const { success } = await ratelimit.limit(ip)

  if (!success) {
    return NextResponse.json(
      { error: 'Too many requests' },
      { status: 429 }
    )
  }

  // Proceed with request
}
```

## API Response Formats

### Success Response

**Pattern**:
```json
{
  "success": true,
  "data": { /* response data */ }
}
```

**Example**:
```json
{
  "success": true,
  "data": {
    "user": {
      "id": "123",
      "email": "user@example.com"
    }
  }
}
```

### Error Response

**Pattern**:
```json
{
  "success": false,
  "error": "Error message",
  "details": { /* optional error details */ }
}
```

**Example**:
```json
{
  "success": false,
  "error": "Invalid email format",
  "details": {
    "field": "email",
    "received": "invalid-email"
  }
}
```

### Pagination Response

[REVIEW: Document if pagination is implemented]

**Pattern**:
```json
{
  "success": true,
  "data": [ /* items */ ],
  "pagination": {
    "page": 1,
    "limit": 10,
    "total": 100,
    "totalPages": 10
  }
}
```

## Testing API Routes

### Manual Testing

**Using curl**:
```bash
# Get session
curl http://localhost:3000/api/auth/session

# Generate token (requires session cookie)
curl -X POST http://localhost:3000/api/auth/generate-token \
  -H "Cookie: next-auth.session-token=your-session-token"

# Sign out
curl -X POST http://localhost:3000/api/auth/signout
```

**Using Postman/Insomnia**:
1. Import session cookie from browser (DevTools → Application → Cookies)
2. Add to request headers
3. Test endpoints

### Automated Testing

[REVIEW: Document Jest tests for API routes if implemented]

**Example**:
```typescript
import { POST } from '@/app/api/auth/generate-token/route'
import { auth } from '@/lib/auth'

jest.mock('@/lib/auth')

describe('POST /api/auth/generate-token', () => {
  it('returns token for valid session', async () => {
    ;(auth as jest.Mock).mockResolvedValue({
      user: {
        id: '123',
        email: 'test@example.com',
        name: 'Test User',
      },
    })

    const response = await POST()
    const data = await response.json()

    expect(data.success).toBe(true)
    expect(data.token).toBeDefined()
  })

  it('returns 401 for invalid session', async () => {
    ;(auth as jest.Mock).mockResolvedValue(null)

    const response = await POST()

    expect(response.status).toBe(401)
  })
})
```

## API Security

### Authentication Strategies

1. **Session-based** (NextAuth session cookie)
   - Used by: `/api/auth/generate-token`
   - Automatically verified by `auth()` function
   - HTTP-only cookies (not accessible via JavaScript)

2. **JWT-based** (custom dashboard token)
   - Used by: Dashboard app (external)
   - Verified by dashboard using shared `JWT_SECRET`
   - Short expiration (7 days)

### Security Headers

**Configured in** `next.config.mjs`:
```javascript
async headers() {
  return [
    {
      source: '/(.*)',
      headers: [
        { key: 'X-DNS-Prefetch-Control', value: 'on' },
        // Add more security headers
      ],
    },
  ]
}
```

**Recommended Headers** [REVIEW: Are these implemented?]:
```javascript
{ key: 'X-Frame-Options', value: 'DENY' },
{ key: 'X-Content-Type-Options', value: 'nosniff' },
{ key: 'Referrer-Policy', value: 'origin-when-cross-origin' },
{ key: 'Permissions-Policy', value: 'camera=(), microphone=(), geolocation=()' },
```

### Input Sanitization

**SQL Injection Prevention**:
- ✅ Prisma parameterizes all queries automatically
- ✅ Never use `$queryRawUnsafe` with user input

**XSS Prevention**:
- ✅ React escapes JSX output automatically
- ✅ Email templates escape HTML with dedicated function
- ⚠️ Validate/sanitize user input before storing

**CSRF Prevention**:
- ✅ NextAuth includes CSRF protection
- ✅ SameSite cookies (Lax by default)

## Monitoring & Logging

[REVIEW: Document monitoring/logging solution]

**Recommended Tools**:
- **Sentry** - Error tracking
- **LogRocket** - Session replay
- **Vercel Analytics** - Performance monitoring
- **DataDog** - APM monitoring

**Logging Pattern**:
```typescript
export async function POST() {
  try {
    // ... operation
    console.log('Operation succeeded', { userId: session.user.id })
  } catch (error) {
    console.error('Operation failed', { error, userId: session.user.id })
    // Send to error tracking service
  }
}
```

---

*Last Updated: January 2025*
*Version: 1.0.0*
